var C=Object.defineProperty;var k=(n,e,t)=>e in n?C(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var a=(n,e,t)=>(k(n,typeof e!="symbol"?e+"":e,t),t);const P=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}};P();var u=(n=>(n.Paint="paint",n.Zoom="zoom",n.Unzoom="unzoom",n.Drag="drag",n.Erase="erase",n.Bucket="bucket",n.Line="line",n))(u||{});class O{constructor(e,t){a(this,"_zoomValue",1);a(this,"_translate",{x:0,y:0});this._frame=e,this._canvas=t,document.addEventListener("fullscreenchange",s=>{this.fitSketch()})}get zoomValue(){return this._zoomValue}set zoomValue(e){this._zoomValue=e,this._canvas.style.width=this._canvas.width*this._zoomValue+"px";const t=this._frame.getBoundingClientRect();this.translate={x:-(t.width-this._canvas.width*this._zoomValue)/2,y:-(t.height-this._canvas.height*this._zoomValue)/2}}get translate(){return this._translate}set translate(e){this._translate=e,this._canvas.style.setProperty("transform",`translate(${-this._translate.x}px,${-this._translate.y}px)`)}fitSketch(){const{width:e,height:t}=this._frame.getBoundingClientRect(),s=this._canvas.width/this._canvas.height,i=e/t;this.zoomValue=s<i?t/this._canvas.height:e/this._canvas.width}zoom(e,t){let s=this._zoomValue>1?this._zoomValue+1:this._zoomValue*2;if(t&&t<0&&(s=this._zoomValue>1?this._zoomValue-1:this._zoomValue*.999999),s=Math.max(1,Math.min(50,s)),e){e.x=Math.min(Math.max(e.x,0),this._canvas.width),e.y=Math.min(Math.max(e.y,0),this._canvas.width);const i=e.x*s-e.x*this._zoomValue+this._translate.x,r=e.y*s-e.y*this._zoomValue+this._translate.y;this._translate={x:i,y:r}}this._zoomValue=s,this._canvas.style.width=this._canvas.width*this._zoomValue+"px",this._canvas.style.setProperty("transform",`translate(${-this._translate.x}px,${-this._translate.y}px)`)}drag(e,t){const s=t.x-e.x,i=t.y-e.y;this.translate={x:this.translate.x-s,y:this.translate.y-i}}}class x{constructor(){a(this,"_canvas");a(this,"actif",!0);a(this,"_ctx");this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d")}set width(e){this._canvas.width=e}get width(){return this._canvas.width}set height(e){this._canvas.height=e}get height(){return this._canvas.height}draw(e){this.actif&&e.drawImage(this._canvas,0,0)}resize(e,t){const s=this._ctx.getImageData(0,0,this.width,this.height);this.width=e,this.height=t,this._ctx.putImageData(s,0,0)}paint(e,t,s){this._ctx.fillStyle=s||"#000000";const i=t>1?e.x-t/2:e.x,r=t>1?e.y-t/2:e.y;this._ctx.fillRect(Math.floor(i),Math.floor(r),t,t)}erase(e,t){const s=t>1?e.x-t/2:e.x,i=t>1?e.y-t/2:e.y;this._ctx.clearRect(Math.floor(s),Math.floor(i),t,t)}_getColor(e){const[t,s,i,r]=this._ctx.getImageData(e.x,e.y,1,1).data;return[t,s,i,r].join("-")}}class w extends x{clear(){this._ctx.clearRect(0,0,this.width,this.height)}bucket(e,t){this._ctx.fillStyle=t;const s=Math.floor(e.x),i=Math.floor(e.y),r=this._getColor({x:s,y:i});let h=[{x:s,y:i}];const _=(o,c)=>{const d={x:o,y:c-1},l={x:o,y:c+1};d.y>=0&&this._getColor(d)===r&&h.push(d),l.y<this.height&&this._getColor(l)===r&&h.push(l)};let g=[];for(;h.length>0;){const o=h.shift();if(g.push(o),_(o.x,o.y),this._getColor(o)===r){let c=o.x,d=o.x;for(;this._getColor({x:c-1,y:o.y})===r&&c>0;)c--,_(c,o.y);for(;this._getColor({x:d+1,y:o.y})===r&&d<this.width-1;)d++,_(d,o.y);this._ctx.fillRect(c,o.y,d-c+1,1),h.filter(l=>g.find(p=>p.x===l.x&&p.y===l.y)===void 0)}}}line(e,t,s){const i=Math.floor(e.x),r=Math.floor(e.y),h=Math.floor(t.x),_=Math.floor(t.y),g=Math.abs(h-i),o=Math.abs(_-r),c=Math.sign(h-i),d=Math.sign(_-r);if(o===0)for(let l=i;l!==h+c;l+=c)this.paint({x:l,y:r},1,s);else if(g===0)for(let l=r;l!==_+d;l+=d)this.paint({x:i,y:l},1,s);else if(g>=o){const l=2*o,p=-2*g;let m=-g,y=r;for(let f=i;f!==h+c;f+=c)this.paint({x:f,y},1,s),m+=l,m>=0&&(y+=d,m+=p)}else{const l=2*g,p=-2*o;let m=-o,y=i;for(let f=r;f!==_+d;f+=d)this.paint({x:y,y:f},1,s),m+=l,m>=0&&(y+=c,m+=p)}}}class z extends x{constructor(){super();a(this,"_colors",["#909090","#C0C0C0"]);a(this,"_size",4);this.clear()}clear(){for(let t=0;t<this.height/this._size;t++)for(let s=0;s<this.width/this._size;s++){const i=(s+t)%2;this.paint({x:s*this._size,y:t*this._size},this._size,this._colors[i])}}}class b{constructor(){a(this,"_observers",[]);a(this,"_newId",function*(){let e=0;for(;;)yield e,e++}())}subscribe(e){const t=this._newId.next().value;return this._observers.push({id:t,callback:e}),t}unsubscribe(e){this._observers=this._observers.filter(t=>t.id!==e)}notify(e){this._observers.forEach(t=>t.callback(e))}}const M=(n,e)=>Math.sqrt((e.x-n.x)**2+(e.y-n.y)**2);class E{constructor(e){a(this,"_clickObservers",new b);a(this,"_rightClickObservers",new b);a(this,"_dragObservers",new b);a(this,"_pointerMoveObservers",new b);a(this,"_pointerUpObservers",new b);a(this,"_pointerOutObservers",new b);a(this,"_zoomObservers",new b);a(this,"_evtCache",[]);a(this,"_prevDist",null);a(this,"_prevCenter",null);a(this,"_oldPos",null);a(this,"_initPos",null);a(this,"_buttonDown",null);e.addEventListener("pointerdown",t=>{this._handleTouch(t)}),e.addEventListener("pointermove",t=>{this._handleDrag(t)}),e.addEventListener("pointerup",t=>{this._initPos&&this._pointerUpObservers.notify({button:t.button,initPos:this._initPos,newPos:{x:t.clientX,y:t.clientY}}),this._handleOut(t)}),e.addEventListener("pointercancel",t=>{this._handleOut(t)}),e.addEventListener("pointerout",t=>{this._handleOut(t)}),e.addEventListener("wheel",t=>{const s={x:t.clientX,y:t.clientY},i=Math.sign(t.deltaY);this._zoomObservers.notify({pos:s,dir:i})}),e.addEventListener("contextmenu",t=>t.preventDefault())}_handleTouch(e){if(this._evtCache.push(e),this._evtCache.length===1){const t={x:e.clientX,y:e.clientY};this._buttonDown=e.button,this._oldPos=t,e.button===2&&this._rightClickObservers.notify(t),e.button===0&&(this._initPos=t,this._clickObservers.notify(t))}}_handleDrag(e){const t={x:e.clientX,y:e.clientY};for(var s=0;s<this._evtCache.length;s++)if(e.pointerId==this._evtCache[s].pointerId){this._evtCache[s]=e;break}if(this._evtCache.length===2){const i={x:this._evtCache[1].clientX,y:this._evtCache[1].clientY},r={x:this._evtCache[0].clientX,y:this._evtCache[0].clientY},h=M(r,i),_=this._evtCache[0].clientX+(this._evtCache[1].clientX-this._evtCache[0].clientX)/2,g=this._evtCache[0].clientY+(this._evtCache[1].clientY-this._evtCache[0].clientY)/2,o={x:_,y:g};if(this._prevDist!==null){const c=h-this._prevDist;this._prevCenter!==null&&h<100?this._dragObservers.notify({button:1,oldPos:this._prevCenter,newPos:o,initPos:this._initPos||{x:0,y:0}}):c>.5?this._zoomObservers.notify({pos:o,dir:-1}):-c>.5&&this._zoomObservers.notify({pos:o,dir:1})}this._prevDist=h,this._prevCenter=o}else this._buttonDown===null?this._pointerMoveObservers.notify({oldPos:this._oldPos||{x:-1,y:-1},newPos:t}):this._buttonDown!==null&&this._oldPos&&(this._dragObservers.notify({oldPos:this._oldPos,newPos:t,button:this._buttonDown,initPos:this._initPos||{x:0,y:0}}),this._oldPos=t)}_handleOut(e){const t={x:e.clientX,y:e.clientY};this._buttonDown=null,this._pointerOutObservers.notify(t),this._evtCache=this._evtCache.filter(s=>s.pointerId!==e.pointerId),this._prevDist=null,this._prevCenter=null,this._initPos=null}addObserver(e,t){switch(e){case"click":return this._clickObservers.subscribe(t);case"rightClick":return this._rightClickObservers.subscribe(t);case"drag":return this._dragObservers.subscribe(t);case"pointerMove":return this._pointerMoveObservers.subscribe(t);case"pointerUp":return this._pointerUpObservers.subscribe(t);case"pointerOut":return this._pointerOutObservers.subscribe(t);case"zoom":return this._zoomObservers.subscribe(t);default:return-1}}removeObserver(e,t){switch(e){case"click":return this._clickObservers.unsubscribe(t);case"rightClick":return this._rightClickObservers.unsubscribe(t);case"drag":return this._dragObservers.unsubscribe(t);case"pointerMove":return this._pointerMoveObservers.unsubscribe(t);case"pointerUp":return this._pointerUpObservers.unsubscribe(t);case"pointerOut":return this._pointerOutObservers.unsubscribe(t);case"zoom":return this._zoomObservers.unsubscribe(t);default:return null}}}class L extends HTMLElement{constructor(){super();a(this,"color","#000000");a(this,"_canvas");a(this,"_ctx");a(this,"_drawing");a(this,"_cursor");a(this,"_background");a(this,"_mode",u.Paint);a(this,"camera");a(this,"_eventsManager");a(this,"size",1);this._canvas=this._createCanvas(),this._ctx=this._canvas.getContext("2d"),this._drawing=new w,this._cursor=new w,this._background=new z,this.camera=new O(this,this._canvas),this._eventsManager=new E(this)}connectedCallback(){this.camera.fitSketch(),this._updatePreview(),this._addEvents()}_createCanvas(){const t=this.attachShadow({mode:"open"}),s=document.createElement("canvas"),i=document.createElement("style");return i.textContent=`
        canvas{
			-ms-interpolation-mode: nearest-neighbor;
			image-rendering: pixelated;    
			background-color: #ffff;
			cursor:crosshair;
        }
        `,t.appendChild(s),t.appendChild(i),s}set mode(t){for(const s of Object.values(u))s===t&&(this._mode=s)}static get observedAttributes(){return["width","height"]}attributeChangedCallback(t,s,i){if(!i||isNaN(Number(i)))return;const r=Number(i);switch(t){case"width":if(r>=1){const _=this._ctx.getImageData(0,0,this._canvas.width,this._canvas.height);this._canvas.width=r,this._ctx.putImageData(_,0,0),this._drawing.resize(r,this._canvas.height),this._cursor.resize(r,this._canvas.height),this._background.resize(r,this._canvas.height),this.camera.fitSketch()}break;case"height":const h=this._ctx.getImageData(0,0,this._canvas.width,this._canvas.height);this._canvas.height=r,this._ctx.putImageData(h,0,0),this._drawing.resize(this._canvas.width,r),this._cursor.resize(this._canvas.width,r),this._background.resize(this._canvas.width,r),this.camera.fitSketch();break;default:return}}_handleLeftClick(t){const{newPos:s,oldPos:i}=t,r=this._gridCoordinate(s);switch(this._mode){case u.Paint:this._drawing.paint(r,this.size,this.color),this._updatePreview();break;case u.Zoom:this.camera.zoom(r);break;case u.Unzoom:this.camera.zoom(r,-1);break;case u.Erase:this._drawing.erase(r,this.size),this._updatePreview();break;case u.Bucket:this._drawing.bucket(r,this.color),this._updatePreview();break;case u.Drag:console.log("oe",i),i&&this.camera.drag(i,s);break}}_handleRightClick(t){const s=this._gridCoordinate(t);this._drawing.erase(s,this.size),this._updatePreview(),this._cursor.actif=!1}_handleZoom(t){const{pos:s,dir:i}=t,r=this._gridCoordinate(s);i>0?this.camera.zoom(r,-1):this.camera.zoom(r,1)}_handleMove(t){const s=this._gridCoordinate(t.newPos);this._mode===u.Paint&&(this._cursor.actif=!0,this._cursor.clear(),this._cursor.paint(s,this.size,this.color),this._updatePreview())}_addEvents(){this._eventsManager.addObserver("click",t=>{const s=t;this._handleLeftClick({newPos:s})}),this._eventsManager.addObserver("rightClick",t=>{this._handleRightClick(t)}),this._eventsManager.addObserver("pointerUp",t=>{if(this._mode===u.Line){const s=this._gridCoordinate(t.initPos),i=this._gridCoordinate(t.newPos);this._drawing.line(s,i,this.color),this._updatePreview()}}),this._eventsManager.addObserver("drag",t=>{const{button:s,oldPos:i,newPos:r}=t;switch(s){case 1:this.camera.drag(i,r);break;case 2:this._handleRightClick(r);break;default:if(this._mode===u.Paint||this._mode===u.Erase||this._mode===u.Drag)this._handleLeftClick(t);else if(this._mode===u.Line){this._cursor.actif=!0;const h=this._gridCoordinate(t.initPos),_=this._gridCoordinate(t.newPos);this._cursor.clear(),this._cursor.line(h,_,this.color),this._updatePreview()}break}}),this._eventsManager.addObserver("pointerMove",t=>{this._handleMove(t)}),this._eventsManager.addObserver("pointerOut",()=>{this._cursor.actif=!1,this._updatePreview()}),this._eventsManager.addObserver("zoom",t=>{this._handleZoom(t)})}_updatePreview(){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._background.draw(this._ctx),this._drawing.draw(this._ctx),this._cursor.draw(this._ctx)}clear(){this._background.clear(),this._drawing.clear(),this._cursor.clear(),this._updatePreview()}_gridCoordinate({x:t,y:s}){const{left:i,top:r}=this._canvas.getBoundingClientRect(),h=(t-i)/this.camera.zoomValue,_=(s-r)/this.camera.zoomValue;return{x:h,y:_}}}customElements.define("sketch-app",L);const v=document.querySelector("sketch-app"),D=document.querySelectorAll(".clr"),V=document.querySelectorAll(".size"),S=document.querySelectorAll(".tool");D.forEach(n=>{const e=n.querySelector("input"),t=n.querySelector("label");t==null||t.style.setProperty("background-color",e.value),e.addEventListener("click",s=>v.color=e.value)});V.forEach(n=>{const e=n.querySelector("input"),t=n.querySelector("label");t==null||t.style.setProperty("width",Number(e.value)*4+"px"),t==null||t.addEventListener("click",s=>v.size=Number(e.value))});S.forEach(n=>{const e=n.querySelector("input,button");e.addEventListener("click",t=>{switch(e.value){case"paint":v.mode="paint";break;case"line":v.mode="line";break;case"erase":v.mode="erase";break;case"zoom":v.mode="zoom";break;case"unzoom":v.mode="unzoom";break;case"handle":v.mode="drag";break;case"bucket":v.mode="bucket";break;case"delete":v.clear();break;case"fitscreen":v.camera.fitSketch();break}})});document.addEventListener("load",n=>{v.camera.fitSketch(),console.log("ok")});
